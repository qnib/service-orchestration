version: '3.3'
services:
  slapd:
    image: qnib/plain-openldap-qnibinc@sha256:5d9316020781797628e3841dc794118cc9643c65c476fc3cf7aa7dcfe0700958
  server:
    image: qnib/alplain-gocd-server:17.10.0@sha256:f08ca8d31036d9a1e1ce2327fc606febfbbc011d5ab1db52f72b8be431d54ccf
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager
    ports:
     - 8153:8153
     - 8154:8154
    configs:
      - source: gocd_config_ldap
        target: /opt/qnib/gocd/gocd-config.tar
        uid: '0'
        gid: '0'
        mode: 0400
    environment:
     - GOCD_SERVER_CLEAN_WORKSPACE=false
     - GOCD_AGENT_AUTOENABLE_KEY=qnibFTW
  agent:
    image: qnib/alplain-gocd-agent:17.10.0@sha256:7b33ef377eb3c5628d50598b1802bbfc86c41d230d552ff25726407a27997760
    hostname: "{{.Service.Name}}.{{.Task.Slot}}.{{.Task.ID}}"
    deploy:
      replicas: 1
      update_config:
        parallelism: 1
        delay: 5s
      restart_policy:
        condition: on-failure
    environment:
     - GO_SERVER_URL=https://tasks.server:8154/go
     - DOCKER_HOST=unix:///var/run/docker.sock
     - GOCD_AGENT_AUTOENABLE_KEY=qnibFTW
    volumes:
     - /var/run/docker.sock:/var/run/docker.sock

configs:
  gocd_config_ldap:
    file: ./config/gocd-config.tar
